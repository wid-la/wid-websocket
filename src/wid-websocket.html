<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../promise-polyfill/promise-polyfill-lite.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <wid-websocket></wid-websocket>

@group Seed Elements
@element wid-websocket
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="wid-websocket">

  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  </template>

</dom-module>

<script>
  (function () {

    let _ws = {}, // map of websockets indexed by the url of the websocket
        _promises = {}; // we open only one websocket to a server

    function noop() {}

    Polymer({

      is: 'wid-websocket',

      properties: {
        url: {
          type: String
        },

        auto: {
          type: Boolean,
          value: false
        },

        json: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_urlChanged(url, auto)'
      ],

      readyState: function () {
        if(_ws[this.url]) {
          return _ws[this.url].readyState;
        } else {
          return -1;
        }
      },

      open: function () {
        this._connect();
      }, 

      send: function (data) {
        if(!_ws[this.url]) {
          throw new Error(`wid-websocket.send(...): not connected for ${this.url}.`);
        }
        if(this.json) {
          data = JSON.stringify(data);
        }
        _promises[this.url].then(() => {
          _ws[this.url].send(data);
        });
      },

      close: function (code, reason) {
        if(_ws[this.url]) {
          _ws[this.url].close(code, reason);
          _ws[this.url] = null;
        }
      },

      _urlChanged: function () {
        if (this.auto) {
          this._connect();
        }
      },

      _connect: function () {
        if(!this.url) {
          throw new Error('wid-websocket.connect(...): no url.');
        }
        if(_ws[this.url]) {
          let ws = _ws[this.url];
          ws.addEventListener('open', this._onwsopen.bind(this, noop));
          ws.addEventListener('error', this._onwserror.bind(this, noop));
          ws.addEventListener('message', this._onwsmessage.bind(this));
          ws.addEventListener('close', this._onwsclose.bind(this));
          return this.readyState();
        }
        
        _promises[this.url] = new Promise((resolve, reject) => {
          let ws = _ws[this.url] = new WebSocket(this.url);

          ws.addEventListener('open', this._onwsopen.bind(this, resolve));
          ws.addEventListener('error', this._onwserror.bind(this, reject));
          ws.addEventListener('message', this._onwsmessage.bind(this));
          ws.addEventListener('close', this._onwsclose.bind(this));
        });
      },

      _onwsopen: function (cb) {
        this.fire('open');
        cb(this.readyState);
      },
      
      _onwserror: function (cb) {
        this.fire('error');
        cb(this.readyState);
      },
      
      _onwsmessage: function (event) {
        var data = event.data;
        if(this.json) {
          data = JSON.parse(data);
        }
        this.fire('message', { data });
      },
      
      _onwsclose: function (event) {
        this.fire('error', { code: event.code, reason: event.reason });
      }

    });

  })();
</script>
